"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_jqmin=require("jqmin"),_jqmin2=_interopRequireDefault(_jqmin),_AX6Util=require("../AX6Util"),_AX6Util2=_interopRequireDefault(_AX6Util),_AX6UIGrid_page=require("./AX6UIGrid_page"),_AX6UIGrid_page2=_interopRequireDefault(_AX6UIGrid_page),_AX6UIGrid_util=require("./AX6UIGrid_util"),_AX6UIGrid_util2=_interopRequireDefault(_AX6UIGrid_util),clearGroupingData=function(t){for(var i=0,e=t.length,s=[];i<e;i++)t[i]&&!t[i].__isGrouping&&(t[i][this.config.columnKeys.selected]&&this.selectedDataIndexs.push(i),s.push(_jqmin2.default.extend({},t[i])));return s},initData=function(t){this.selectedDataIndexs=[];var i=0,e=t.length,s=[],l=0,n=0,a=0;if(this.config.body.grouping)for(var o=_AX6Util2.default.map(this.bodyGrouping.by,function(){return{key:this,compareString:"",grouping:!1,list:[]}}),r=0,h=o.length,d=void 0,c=[],u=void 0;i<e+1;i++)if(r=0,t[i]&&t[i][this.config.columnKeys.deleted])this.deletedList.push(t[i]);else{for(d="",c=[];r<h;r++){if(t[i]&&(d+="$|$"+t[i][o[r].key]),l>0&&d!=o[r].compareString){for(var f={keys:[],labels:[],list:o[r].list},g=0;g<r+1;g++)f.keys.push(o[g].key),f.labels.push(t[i-1][o[g].key]);c.push(f),o[r].list=[]}o[r].list.push(t[i]),o[r].compareString=d}for(u=c.length;u--;)s.push({__isGrouping:!0,__groupingList:c[u].list,__groupingBy:{keys:c[u].keys,labels:c[u].labels}});t[i]&&(t[i][this.config.columnKeys.selected]&&this.selectedDataIndexs.push(i),t[i].__original_index=t[i].__index=a,s.push(t[i]),n++,l++,a++)}else for(;i<e;i++)t[i]&&(t[i][this.config.columnKeys.deleted]?this.deletedList.push(t[i]):(t[i][this.config.columnKeys.selected]&&this.selectedDataIndexs.push(i),void 0===t[i].__original_index&&(t[i].__original_index=a),t[i].__index=a,n++,a++,s.push(t[i])));return this.xvar.dataRealRowCount=n,s},arrangeData4tree=function(t){this.selectedDataIndexs=[],this.deletedList=[];for(var i=0,e=0,s=0,l=0,n=t.length,a=this.config.tree.columnKeys,o=this.config.tree.hashDigit,r={};n--;)delete t[n][a.parentHash],delete t[n][a.selfHash];for(i=0,e=0,n=t.length;i<n;i++)t[i]&&(r[t[i][a.selfKey]]=i,(_AX6Util2.default.isNothing(t[i][a.parentKey])||"top"===t[i][a.parentKey])&&(t[i][a.parentKey]="top",t[i][a.children]=[],t[i][a.parentHash]=_AX6Util2.default.setDigit("0",o),t[i][a.selfHash]=_AX6Util2.default.setDigit("0",o)+"."+_AX6Util2.default.setDigit(e,o),t[i][a.depth]=0,t[i][a.hidden]=!1,e++));for(i=0,l=0;i<n;i++){var h=void 0,d=void 0;t[i]&&"top"!==t[i][a.parentKey]&&void 0===t[i][a.parentHash]&&((h=t[r[t[i][a.parentKey]]])?(d=h[a.selfHash],t[i][a.children]=[],t[i][a.parentHash]=d,t[i][a.selfHash]=d+"."+_AX6Util2.default.setDigit(h[a.children].length,o),t[i][a.depth]=h[a.depth]+1,(h[a.collapse]||h[a.hidden])&&(t[i][a.hidden]=!0),h[a.children].push(t[i][a.selfKey])):(t[i][a.parentKey]="top",t[i][a.children]=[],t[i][a.parentHash]=_AX6Util2.default.setDigit("0",o),t[i][a.selfHash]=_AX6Util2.default.setDigit("0",o)+"."+_AX6Util2.default.setDigit(e,o),t[i][a.hidden]=!1,e++)),t[i]&&(t[i][this.config.columnKeys.deleted]?(this.deletedList.push(t[i]),t[i][a.hidden]=!0):t[i][this.config.columnKeys.selected]&&this.selectedDataIndexs.push(i),t[i].__index=l,s++,l++)}return this.listIndexMap=r,this.xvar.dataRealRowCount=s,t},set=function(t){var i=void 0;return _AX6Util2.default.isArray(t)?(this.page=null,i=t):"page"in t&&(this.page=_jqmin2.default.extend({},t.page),i=t.list),this.config.tree.use?(this.list=arrangeData4tree.call(this,i),this.proxyList=getProxyList.call(this,sort.call(this,this.sortInfo,this.list))):(this.proxyList=null,this.list=initData.call(this,!this.config.remoteSort&&Object.keys(this.sortInfo).length?sort.call(this,this.sortInfo,i):i)),this.selectedDataIndexs=[],this.deletedList=[],this.needToPaintSum=!0,this.xvar.frozenRowIndex=this.config.frozenRowIndex>this.list.length?this.list.length:this.config.frozenRowIndex,this.xvar.paintStartRowIndex=void 0,this.xvar.virtualPaintStartRowIndex=void 0,_AX6UIGrid_page2.default.navigationUpdate.call(this),this.config.body.grouping,this},get=function(){return{list:this.list,page:this.page}},getList=function(t){var i=[],e=this.list,s=0,l=e.length;switch(t){case"modified":for(;s<l;s++)e[s]&&!e[s].__isGrouping&&e[s][this.config.columnKeys.modified]&&i.push(_jqmin2.default.extend({},e[s]));break;case"selected":for(;s<l;s++)e[s]&&!e[s].__isGrouping&&e[s][this.config.columnKeys.selected]&&i.push(_jqmin2.default.extend({},e[s]));break;case"deleted":i=[].concat(this.deletedList);break;default:i=clearGroupingData.call(this,e)}return i},getProxyList=function(t){for(var i=0,e=t.length,s=[];i<e;i++)t[i]&&!t[i][this.config.tree.columnKeys.hidden]&&(t[i].__origin_index__=i,s.push(t[i]));return s},setValue=function(t,i,e,s){var l=getValue.call(this,t,i,e),n=this.list,a=void 0===i?t:i;if(this.needToPaintSum=!0,l!==s){if(/[\.\[\]]/.test(e))try{n[a][this.config.columnKeys.modified]=!0,Function("val","this"+_AX6UIGrid_util2.default.getRealPathForDataItem(e)+" = val;").call(n[a],s)}catch(t){}else n[a][this.config.columnKeys.modified]=!0,n[a][e]=s;this.onDataChanged&&this.onDataChanged.call({self:this,list:this.list,dindex:t,doindex:i,item:this.list[t],key:e,value:s})}return!0},getValue=function(t,i,e,s){var l=this.list,n=void 0===i?t:i;if(/[\.\[\]]/.test(e))try{s=Function("","return this"+_AX6UIGrid_util2.default.getRealPathForDataItem(e)+";").call(l[n])}catch(t){}else s=l[n][e];return s},clearSelect=function(){this.selectedDataIndexs=[]},select=function(t,i,e,s){var l=this.config;return void 0===i&&(i=t),!!this.list[i]&&(!this.list[i].__isGrouping&&(!this.list[i][l.columnKeys.disableSelection]&&(void 0===e?(this.list[i][l.columnKeys.selected]=!this.list[i][l.columnKeys.selected])?this.selectedDataIndexs.push(i):this.selectedDataIndexs.splice(_AX6Util2.default.search(this.selectedDataIndexs,function(){return this==i}),1):(this.list[i][l.columnKeys.selected]=e)?this.selectedDataIndexs.push(i):this.selectedDataIndexs.splice(_AX6Util2.default.search(this.selectedDataIndexs,function(){return this==i}),1),this.onDataChanged&&s&&s.internalCall&&this.onDataChanged.call({self:this,list:this.list,dindex:t,doindex:i,item:this.list[i],key:l.columnKeys.selected,value:this.list[i][l.columnKeys.selected]}),this.list[i][l.columnKeys.selected])))},selectAll=function(t,i){var e=this.config,s=this.list.length;if(this.selectedDataIndexs=[],void 0===t)for(;s--;)this.list[s].__isGrouping||i&&i.filter&&!0!==i.filter.call(this.list[s])||this.list[s][e.columnKeys.disableSelection]||(this.list[s][e.columnKeys.selected]=!this.list[s][e.columnKeys.selected])&&this.selectedDataIndexs.push(s);else for(;s--;)this.list[s].__isGrouping||i&&i.filter&&!0!==i.filter.call(this.list[s])||this.list[s][e.columnKeys.disableSelection]||(this.list[s][e.columnKeys.selected]=t)&&this.selectedDataIndexs.push(s);return this.onDataChanged&&i&&i.internalCall&&this.onDataChanged.call({self:this,list:this.list}),this.list},add=function(t,i,e){var s=this.config.body.grouping?clearGroupingData.call(this,this.list):this.list,l={first:function(){s=[].concat(t).concat(s)},last:function(){s=s.concat([].concat(t))}};if(this.config.tree.use){var n=this.list.concat([].concat(t));this.list=arrangeData4tree.call(this,n),this.proxyList=getProxyList.call(this,sort.call(this,this.sortInfo,this.list))}else{if(void 0===i&&(i="last"),i in l)t[this.config.columnKeys.modified]=!0,l[i].call(this,t);else{if(!_AX6Util2.default.isNumber(i))throw"invalid argument _dindex";if(_AX6Util2.default.isArray(t))for(var a=0,o=t.length;a<o;a++)s.splice(i+a,0,t[a]);else s.splice(i,0,t)}s=this.config.body.grouping?initData.call(this,sort.call(this,this.sortInfo,s)):e&&e.sort&&Object.keys(this.sortInfo).length?initData.call(this,sort.call(this,this.sortInfo,s)):initData.call(this,s),this.list=s}return this.needToPaintSum=!0,this.xvar.frozenRowIndex=this.config.frozenRowIndex>this.list.length?this.list.length:this.config.frozenRowIndex,this.xvar.paintStartRowIndex=void 0,this.xvar.virtualPaintStartRowIndex=void 0,_AX6UIGrid_page2.default.navigationUpdate.call(this),this},remove=function(t){var i=this.config.body.grouping?clearGroupingData.call(this,this.list):this.list,e={first:function(){this.config.tree.use?e.tree.call(this,0):i.splice(0,1)},last:function(){this.config.tree.use?e.tree.call(this,i.length-1):i.splice(i.length-1,1)},index:function(t){this.config.tree.use?e.tree.call(this,t):i.splice(t,1)},selected:function(){if(this.config.tree.use)e.tree.call(this,"selected");else{var t=[],s=void 0,l=void 0;for(s=0,l=i.length;s<l;s++)i[s][this.config.columnKeys.selected]||t.push(i[s]);i=t,t=null,s=null}},tree:function(t){var e=this.config.tree.columnKeys,s=i[t][this.config.tree.columnKeys.selfHash];i=_AX6Util2.default.filter(i,function(){return this[e.selfHash].substr(0,s.length)!=s}),e=null,s=null}};if(void 0===t&&(t="last"),t in e)e[t].call(this,t);else{if(!_AX6Util2.default.isNumber(t))throw"invalid argument _dindex";e.index.call(this,t)}return this.config.tree.use?(this.list=arrangeData4tree.call(this,i),this.proxyList=getProxyList.call(this,sort.call(this,this.sortInfo,this.list))):(i=this.config.body.grouping?initData.call(this,sort.call(this,this.sortInfo,i)):Object.keys(this.sortInfo).length?initData.call(this,sort.call(this,this.sortInfo,i)):initData.call(this,i),this.list=i),this.needToPaintSum=!0,this.xvar.frozenRowIndex=this.config.frozenRowIndex>this.list.length?this.list.length:this.config.frozenRowIndex,this.xvar.paintStartRowIndex=void 0,this.xvar.virtualPaintStartRowIndex=void 0,_AX6UIGrid_page2.default.navigationUpdate.call(this),this},deleteRow=function(t){var i=this.config.body.grouping?clearGroupingData.call(this,this.list):this.list,e={first:function(){this.config.tree.use?e.tree.call(this,0):i[0][this.config.columnKeys.deleted]=!0},last:function(){this.config.tree.use?e.tree.call(this,i.length-1):i[i.length-1][this.config.columnKeys.deleted]=!0},selected:function(){if(this.config.tree.use)e.tree.call(this,"selected");else{for(var t=i.length;t--;)i[t][this.config.columnKeys.selected]&&(i[t][this.config.columnKeys.deleted]=!0);t=null}},tree:function(t){var e=this.config.columnKeys,s=this.config.tree.columnKeys;if("selected"===t){for(var l=i.length;l--;)if(i[l][this.config.columnKeys.selected]){i[l][this.config.columnKeys.deleted]=!0;for(var n=i[l][s.selfHash],a=i.length;a--;)i[a][s.selfHash].substr(0,n.length)===n&&(i[a][e.deleted]=!0);n=null,a=null}l=null}else{for(var o=i[t][s.selfHash],r=i.length;r--;)i[r][s.selfHash].substr(0,o.length)!==o&&(i[r][e.deleted]=!0);o=null,r=null}e=null,s=null}};if(void 0===t&&(t="last"),t in e)e[t].call(this,t);else{if(!_AX6Util2.default.isNumber(t))throw"invalid argument _dindex";i[t][this.config.columnKeys.deleted]=!0}return this.config.tree.use?(this.list=arrangeData4tree.call(this,i),this.proxyList=getProxyList.call(this,sort.call(this,this.sortInfo,this.list))):(i=this.config.body.grouping?initData.call(this,sort.call(this,this.sortInfo,i)):Object.keys(this.sortInfo).length?initData.call(this,sort.call(this,this.sortInfo,i)):initData.call(this,i),this.list=i),this.needToPaintSum=!0,this.xvar.frozenRowIndex=this.config.frozenRowIndex>this.list.length?this.list.length:this.config.frozenRowIndex,this.xvar.paintStartRowIndex=void 0,this.xvar.virtualPaintStartRowIndex=void 0,_AX6UIGrid_page2.default.navigationUpdate.call(this),this},update=function(t,i){if(!_AX6Util2.default.isNumber(i))throw"invalid argument _dindex";this.needToPaintSum=!0,this.list.splice(i,1,t),this.config.body.grouping&&(this.list=initData.call(this,clearGroupingData.call(this,this.list)))},updateChild=function(t,i,e){var s=this.config.tree.columnKeys,l=void 0,n=void 0;if(void 0===t)return!1;if(n=this.proxyList[t].__origin_index__,this.list[n][s.children]){if(this.proxyList=[],e&&e.filter){if(e.filter.call({item:this.list[n],dindex:n},this.list[n]))for(var a in i)this.list[n][a]=i[a]}else for(var o in i)this.list[n][o]=i[o];l=this.list[n][s.selfHash];for(var r=0,h=this.list.length;r<h;r++)if(this.list[r]){if(this.list[r][s.parentHash].substr(0,l.length)===l)if(e&&e.filter){if(e.filter.call({item:this.list[r],dindex:r},this.list[r]))for(var d in i)this.list[r][d]=i[d]}else for(var c in i)this.list[r][c]=i[c];this.list[r][s.hidden]||this.proxyList.push(this.list[r])}return!0}return!1},sort=function(t,i,e){var s=i||this.list,l=[],n=0,a=function(t,i,e){if(/[\.\[\]]/.test(i))try{e=Function("","return this"+_AX6UIGrid_util2.default.getRealPathForDataItem(i)+";").call(t)}catch(t){}else e=t[i];return e};for(var o in t)l[t[o].seq]={key:o,order:t[o].orderBy};l=_AX6Util2.default.filter(l,function(){return void 0!==this}),e&&e.resetLineNumber&&0===l.length&&(l[0]={key:"__original_index",order:"asc"});var r=0,h=l.length,d=void 0,c=void 0;if(s.sort(function(t,i){for(r=0;r<h;r++){if(d=a(t,l[r].key),c=a(i,l[r].key),(void 0===d?"undefined":_typeof(d))!==(void 0===c?"undefined":_typeof(c))&&(d=""+d,c=""+c),d<c)return"asc"===l[r].order?-1:1;if(d>c)return"asc"===l[r].order?1:-1}}),e&&e.resetLineNumber)for(r=0,h=s.length,n=0;r<h;r++)i[r]&&!i[r].__isGrouping&&(i[r].__index=n++);return i?s:(this.xvar.frozenRowIndex=this.config.frozenRowIndex>this.list.length?this.list.length:this.config.frozenRowIndex,this.xvar.paintStartRowIndex=void 0,this.xvar.virtualPaintStartRowIndex=void 0,_AX6UIGrid_page2.default.navigationUpdate.call(this),this)},append=function(t,i){var e=this;if(this.config.tree.use){var s=this.list.concat([].concat(t));this.list=arrangeData4tree.call(this,s),this.proxyList=getProxyList.call(this,sort.call(this,this.sortInfo,this.list)),s=null}else this.list=this.list.concat([].concat(t));if(this.appendProgress=!0,_AX6UIGrid_page2.default.statusUpdate.call(this),this.appendDebouncer){if(!(e.appendDebounceTimes<this.config.debounceTime/10))return e.appendDebounceTimes=0,appendIdle.call(e),i(),!1;clearTimeout(this.appendDebouncer),e.appendDebounceTimes++}this.appendDebouncer=setTimeout(function(){e.appendDebounceTimes=0,appendIdle.call(e),i()},this.config.debounceTime)},appendIdle=function(){this.appendProgress=!1,this.config.body.grouping?this.list=initData.call(this,sort.call(this,this.sortInfo,this.list)):this.list=initData.call(this,this.list),this.needToPaintSum=!0,this.xvar.frozenRowIndex=this.config.frozenRowIndex>this.list.length?this.list.length:this.config.frozenRowIndex,this.xvar.paintStartRowIndex=void 0,this.xvar.virtualPaintStartRowIndex=void 0,_AX6UIGrid_page2.default.navigationUpdate.call(this)},toggleCollapse=function(t,i,e){var s=this.config.tree.columnKeys,l=void 0,n=void 0;if(void 0===t)return!1;if(n=this.proxyList[t].__origin_index__,this.list[n][s.children]){this.proxyList=[],void 0===e&&(e=!this.list[n][s.collapse]),this.list[n][s.collapse]=e,l=this.list[n][s.selfHash];for(var a=this.list.length;a--;)this.list[a]&&(this.list[a][s.parentHash].substr(0,l.length)===l&&(this.list[a][s.hidden]=e),this.list[a][s.hidden]||this.proxyList.push(this.list[a]));return!0}return!1};exports.default={init:function(){},set:set,get:get,getList:getList,getProxyList:getProxyList,setValue:setValue,getValue:getValue,clearSelect:clearSelect,select:select,selectAll:selectAll,add:add,remove:remove,deleteRow:deleteRow,update:update,updateChild:updateChild,sort:sort,initData:initData,clearGroupingData:clearGroupingData,append:append,toggleCollapse:toggleCollapse};
//# sourceMappingURL=AX6UIGrid_data.js.map
